
<!DOCTYPE html>
<html>
<head>
<title>Page Title</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
</head>
<body>

    <form method="post" id="form" action="/api/post">
        {% csrf_token %} 
        <label for="your_name">Your name: </label><br>
        <textarea id="htmlInput" name="htmlInput" rows="30" cols="80"></textarea><br><br>
        <button type="button" id="submit">Submit</button>
    </form>
    
    <div id="load_json"></div>

</body>
</html>

<script>
    

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    function loadJson(){
        var load = document.getElementById('load_json')
        var url = "/api/get/"

        async function getJson(url){
            let response = await fetch(url); // Fetch the data
            let jsonData = await response.json(); // Parse the JSON response
            console.log(jsonData);
            // Loop through JSON data and append to the load element
            jsonData.forEach(item => { 
                let div = document.createElement('div');
                div.innerHTML = item.name === "alt"
                    ? `<span>${item.name} -- <input type="text" value="${item.value}" /></span>`
                    : `<span>${item.name} -- ${item.value}</span>`;
                load.appendChild(div);
            });
        }
        getJson(url);
    }

    // convert input dom to json 
    function converter(dom) {
        if (dom.nodeType === Node.TEXT_NODE) {
            return dom.nodeValue;
        }
        if (dom.nodeType === Node.DOCUMENT_NODE) {
            dom = dom.documentElement;
        }
        const obj = {};
        obj.nodeType = dom.nodeType;
        if (dom.nodeType === Node.ELEMENT_NODE) {
            obj.attributes = [];
            for (let i = 0, len = dom.attributes.length; i < len; ++i) {
                const attr = dom.attributes[i];
                if (attr.name === "alt" || attr.name === "src"){
                    obj.attributes.push({ name: attr.name, value: attr.value });
                }

            }
            obj.children = [];
            for (let child = dom.firstChild; child; child = child.nextSibling) {
                obj.children.push(converter(child));
            }
        } else {
            obj.nodeValue = dom.nodeValue;
        }
        return obj
    }

    function extractAttributes(json) {
        const attributes = [];
        
        // Check if the node has attributes and collect the name-value pairs
        if (json.attributes) {
            json.attributes.forEach(attr => {
                attributes.push({
                    name: attr.name,
                    value: attr.value
                });
            });
        }

        // Recursively handle children if they exist
        if (json.children) {
            json.children.forEach(child => {
                const childAttributes = extractAttributes(child); // Recursive call for each child
                attributes.push(...childAttributes); // Merge the result
            });
        }
        console.log(attributes)
        return attributes;
    }

    function parseHTML() {
        const inputHTML = document.getElementById("htmlInput").value;
        if (inputHTML !== "") {
            const parser = new DOMParser();
            const doc = parser.parseFromString(inputHTML, "text/html");

            const json = JSON.stringify(converter(doc.body), null, 4);  // Parse only the body content
            const jsonAttributes = extractAttributes(converter(doc.body));  // Extract the relevant attributes (alt and src)
            submitJSON(JSON.stringify(jsonAttributes));
        }
    }   

    function submitJSON(jsonAttributes){
        var url = "/api/post/"
        fetch(url,{
            method:'POST',
            headers:{
                'Content-Type':'application/json',
                'X-CSRFToken' : csrftoken,
            },
            body:JSON.stringify({htmlJson:jsonAttributes})
        })
        
    }

    var button = document.getElementById("submit");
    button.addEventListener('click', function(e) {
        e.preventDefault(); // Prevent any default behavior (not critical here for a button)
        parseHTML();
        console.log("clicked");
        loadJson();
    });

</script>